trigger:
- master
pr:
- master
pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build stage  
  jobs:
  - job: Build1
    displayName: Build
    steps:
    - task: PowerShell@2
      inputs:
        filePath: '$(System.DefaultWorkingDirectory)/.azure-pipeline/gitdiff.ps1'
        arguments: '$(Build.SourceVersion)'    
    - task: PowerShell@2
      inputs:
        filePath: '$(System.DefaultWorkingDirectory)/.azure-pipeline/ymlparser.ps1'
        arguments: $(System.DefaultWorkingDirectory) $(yamlFileName)
      name: yamlParsedValues  
    - script: echo "#$(yamlParsedValues.cloud)#"  
  - job: Build2
    dependsOn: Build1
    condition: eq(dependencies.Build1.outputs['yamlParsedValues.cloud'], 'fairfax')
    variables:
      cloudFromBuild1: $[ dependencies.Build1.outputs['yamlParsedValues.cloud'] ] 
    steps:      
    - task: PowerShell@2
      inputs:
        filePath: '$(System.DefaultWorkingDirectory)/.azure-pipeline/accounttypeselector.ps1'
        arguments: $(cloudFromBuild1)
  - job: Build3
    dependsOn: Build1
    condition: eq(dependencies.Build1.outputs['yamlParsedValues.cloud'], 'commerical')
    variables:
      cloudFromBuild1: $[ dependencies.Build1.outputs['yamlParsedValues.cloud'] ] 
    steps:      
    - task: PowerShell@2
      inputs:
        filePath: '$(System.DefaultWorkingDirectory)/.azure-pipeline/accounttypeselector.ps1'
        arguments: $(cloudFromBuild1)     
